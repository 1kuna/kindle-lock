# kindle-lock Docker Compose
#
# Usage:
#   Initial setup (Amazon login):
#     KINDLE_SETUP_MODE=true docker compose --profile setup up
#
#   Production with Cloudflare:
#     docker compose --profile cloudflare up -d
#
#   Production with Tailscale:
#     docker compose --profile tailscale up -d
#
#   Production with direct port (BYO reverse proxy):
#     docker compose --profile expose up -d

services:
  # ===========================================
  # Main Application
  # ===========================================
  kindle-lock:
    build:
      context: .
      dockerfile: docker/Dockerfile
    container_name: kindle-lock
    restart: unless-stopped
    environment:
      # Amazon credentials (for initial login)
      - AMAZON_EMAIL=${AMAZON_EMAIL:-}
      - AMAZON_PASSWORD=${AMAZON_PASSWORD:-}
      # API configuration
      - API_HOST=0.0.0.0
      - API_PORT=8080
      - API_SECRET_KEY=${API_SECRET_KEY:-change-me-in-production}
      # Reading goal settings
      - DAILY_PAGE_GOAL=${DAILY_PAGE_GOAL:-30}
      - DAY_RESET_HOUR=${DAY_RESET_HOUR:-4}
      - SCRAPE_INTERVAL_MINUTES=${SCRAPE_INTERVAL_MINUTES:-30}
      # Browser settings
      - BROWSER_HEADLESS=${BROWSER_HEADLESS:-true}
      - KINDLE_SETUP_MODE=${KINDLE_SETUP_MODE:-false}
      # Paths (inside container)
      - DATABASE_PATH=/app/data/reading.db
      - BROWSER_PROFILE_PATH=/app/data/browser_profile
    volumes:
      # Persistent data (database + browser session)
      - kindle-data:/app/data
    # Chromium requires extra shared memory
    shm_size: 1gb
    # Required for Chromium sandbox
    security_opt:
      - seccomp:unconfined
    networks:
      - kindle-net
    # Note: Port 8080 is NOT exposed by default
    # Use a profile to expose it (cloudflare, tailscale, or expose)

  # ===========================================
  # Setup Mode: noVNC for Amazon Login
  # ===========================================
  # Usage: KINDLE_SETUP_MODE=true docker compose --profile setup up
  novnc:
    build:
      context: .
      dockerfile: docker/Dockerfile.novnc
    container_name: kindle-novnc
    profiles:
      - setup
    depends_on:
      - kindle-lock
    ports:
      # Access VNC via browser at http://<host>:6080
      - "6080:6080"
    networks:
      - kindle-net
    restart: "no"

  # ===========================================
  # Remote Access Option 1: Cloudflare Tunnel
  # ===========================================
  # Usage: docker compose --profile cloudflare up -d
  #
  # Setup:
  #   1. Go to https://one.dash.cloudflare.com/
  #   2. Create a tunnel under Access -> Tunnels
  #   3. Copy the tunnel token
  #   4. Set CLOUDFLARE_TUNNEL_TOKEN in .env
  #   5. Configure public hostname -> http://kindle-lock:8080
  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: kindle-cloudflared
    profiles:
      - cloudflare
    command: tunnel run
    environment:
      - TUNNEL_TOKEN=${CLOUDFLARE_TUNNEL_TOKEN}
    depends_on:
      kindle-lock:
        condition: service_healthy
    networks:
      - kindle-net
    restart: unless-stopped

  # ===========================================
  # Remote Access Option 2: Tailscale
  # ===========================================
  # Usage: docker compose --profile tailscale up -d
  #
  # Setup:
  #   1. Go to https://login.tailscale.com/admin/settings/keys
  #   2. Create an auth key (reusable recommended)
  #   3. Set TAILSCALE_AUTHKEY in .env
  #   4. Access via https://kindle-lock.<tailnet>.ts.net
  tailscale:
    image: tailscale/tailscale:latest
    container_name: kindle-tailscale
    profiles:
      - tailscale
    hostname: kindle-lock
    environment:
      - TS_AUTHKEY=${TAILSCALE_AUTHKEY}
      - TS_STATE_DIR=/var/lib/tailscale
      - TS_USERSPACE=true
      - TS_SERVE_CONFIG=/config/serve.json
    volumes:
      - tailscale-state:/var/lib/tailscale
      - ./docker/tailscale-serve.json:/config/serve.json:ro
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    depends_on:
      kindle-lock:
        condition: service_healthy
    networks:
      - kindle-net
    restart: unless-stopped

  # ===========================================
  # Remote Access Option 3: Direct Port Exposure
  # ===========================================
  # Usage: docker compose --profile expose up -d
  #
  # Use this if you have your own reverse proxy (nginx, Caddy, Traefik)
  # or want to add this to an existing tunnel configuration.
  kindle-lock-exposed:
    extends:
      service: kindle-lock
    profiles:
      - expose
    ports:
      - "${API_EXPOSE_PORT:-8080}:8080"

# ===========================================
# Volumes
# ===========================================
volumes:
  # Main data volume (SQLite DB + browser profile)
  kindle-data:
    name: kindle-lock-data
  # Tailscale state (only used with tailscale profile)
  tailscale-state:
    name: kindle-tailscale-state

# ===========================================
# Networks
# ===========================================
networks:
  kindle-net:
    name: kindle-network
